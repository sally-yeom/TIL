## Pipeline-App(PA)을 개발할 때 지켜져야 될 특성 및 구조

### PA가 필요한 상황
+ (준)실시간성 요건
+ 최종 목적은 DB에 데이터 적재
+ [user] -> [sending-server] -> "PA" -> [receiving-server] -> [DB]
  - SS와 RS의 스키마를 맞춰주는 작업은 필수적

### 지켜져야 될 특성
+ 데이터의 아래와 같은 특성을 지키는 것이 PA의 목적으로 귀결
  - 무결성(Integrity)
  - 일관성(Consistency)
+ [wiki](https://ko.wikipedia.org/wiki/데이터_무결성, "wiki link")
+ 아래 내용을 기억하자!
  - SS가 API Call을 견디고
  - PA가 처리가 가능하며
  - RS가 처리가 가능하고
  - DB가 적재 가능해야 한다는 점

### 문제 정의
+ 아래의 장애는 언제든 발생할 수 있음
  - 네트워크 장애
  - 서버 장애
+ 장애 발생 이후 재개시 데이터의 어느 부분이 RS로 정상 유입되었으며, 어느 부분을 다시 유입시켜야 하는가?
+ 고부하 상황에서의 일관성 유지는 어떻게 할 것인가?
  - 특정 데이터를 못 받을 가능성이 있는가?
  - 등장 주체(SS, RS, DB)들 간에 같은 데이터를 제공하는가?
  
### 문제 발생 가능 거점
+ 각 노드의 모든 접점 및 네트워크
+ PA 자체의 비정상 중단
  
### 문제 해결 방법
+ 대부분 스케쥴링 방식을 사용
+ 최대한 개발의 복잡성 및 공수를 줄이며 최대의 효율을 내는 것이 중요
+ 스케쥴링 방식의 구멍은 무엇인가?
+ 간단 버전
  - 기준 시점(데이터 송신 시작 시점) ~ 현재시점 사이의 모든 타임라인을 Time Frame 단위로 동기화 함
  - 아래의 2개의 모듈을 multi-processing 형태로 구성한 후 background로 동작시킴
	1. SS Synchronizer(SSS)는 기준 시점으로부터 현재 시점까지의 모든 1분 단위의 데이터에 대한 누락 지점의 데이터를 받아 저장
		1-1. SS로부터 받은 데이터에 timestamp or datetime 값이 있다고 그것이 정확한 데이터인지 신뢰할 수 없으므로 최대 delay 간격 체크 필요(SS 자체의 latency) 
	2. RS Synchronizer(RSS)는 SSS가 저장한 데이터를 건(not Bulk -> 환경에 따라 바뀔 수 있음) 단위로 무결성을 유지하며 RS에 전송
  - 2 개의 모듈은 각각의 공간(file system)을 활용

### Sync Flow
+ SSS는 본인이 만든 Pulled Frame 또는 RSS가 제공하는 Pushed Frame을 제외한 모든 누락 Frame에 대해 끊임없이 Pulling하여 한 Frame 완료 시 RSS에게 알림(정확히는 RSS는 Pulled Frame이 생기는지 SSS의 공간은 끊임없이 모니터링)
+ RSS는 미완성 Pushing(장애복구) 혹은 새로운 Pulled Frame을 찾아 끊임없이 Push
+ RSS는 Push 과정상에서 건 단위로 Push 및 UID 기록(무결성 파일 - 이 파일이 생긴다는 것은 PA가 데이터의 무결성을 보장하여 전송에 성곡했다는 것을 의미)
+ RSS는 한 Frame Push 완료 시 Done 파일(Pushed Frame) 생성 후 일관성 파일 및 데이터 파일을 지움(PA의 저장소 용량 고려)

### 본 구조의 장점
+ 서버 장애 상황에 유연한 대처가 가능
  - Native한 방식의 스케쥴링을 한다면 서버shutdown 중 데이터에 대한 수작업 복구가 필요  
  - 기준 시점으로부터 현재 시점까지 비어있는 모든 Time Frame을 찾아내어 보내기 때문
+ 고부하 상태 돌입에 비교적 안전하고, Eventual Consistency 유지
  - 고부하 상태에서 받지 못한 데이터를 저부하 상태에서 받음 (EX. 밤시간에 받음)

### 단점
+ 무결성 및 일관성을 보장하기 위한 추가적인 Disk 공간이 필요
  - UID(일관성 파일) 및 PA 수행에서 발생되는 로그 정보들을 저장할 공간이 필요

### 그럼에도 불구하고 잔존 문제는?
+ PA -> RS 간 네트워크 장애 중 특수 상황(Req는 보내고, Res는 못 받은 상황) 에는 대이터가 중복될 수 있음
+ DB 적재가 실시간이 아닐 수 있음(segment 단위로 나누어 batch로 저장할 수 있음 - DB 설정 상)
+ SS의 데이터 제공 가능 시간이 가변성을 지닐 때 적절한 Delay를 줄 수 없음(위의 1-1의 설명과 연결됨)


